package moon

import org.scalatest._
import org.scalatest.matchers.should._

class WsModelSpec extends FlatSpec with Matchers with Inside  {
  val wsMessages =
    """
      |{"success":true,"request":{"op":"authKey","args":["xxxx",1589034691432,"yyy"]}}
      |{"info":"Welcome to the BitMEX Realtime API.","version":"2020-04-29T23:19:10.000Z","timestamp":"2020-05-07T19:00:51.147Z","docs":"https://testnet.bitmex.com/app/wsAPI","limit":{"remaining":39}}
      |{"success":true,"subscribe":"orderBook10:XBTUSD","request":{"op":"subscribe","args":"orderBook10:XBTUSD"}}
      |{"table":"orderBook10","action":"partial","keys":["symbol"],"types":{"symbol":"symbol","bids":"","asks":"","timestamp":"timestamp"},"foreignKeys":{"symbol":"instrument"},"attributes":{"symbol":"sorted"},"filter":{"symbol":"XBTUSD"},"data":[{"symbol":"XBTUSD","bids":[[9770,35719],[9769,31],[9768,50],[9767.5,40],[9765,30],[9764,30],[9763,282],[9762,100],[9760,100],[9759,30]],"asks":[[9770.5,101196],[9771,2095],[9772.5,50],[9773,783],[9773.5,169],[9774,996],[9774.5,167],[9775,3680],[9775.5,353],[9776,198]],"timestamp":"2020-05-07T19:00:47.235Z"}]}
      | {"success":true,"request":{"op":"authKey","args":["KTl_zNoXSONbWlFgRU_6PoiY",1588878047418,"9C5069075AD313F764B2CF41CAFC483EDEC49BD8A68C3BD2414CB134E45F971B"]}}
      | {"success":true,"subscribe":"order:XBTUSD","request":{"op":"subscribe","args":["order:XBTUSD"]}}
      | {"table":"order","action":"partial","keys":["orderID"],"types":{"orderID":"guid","clOrdID":"string","clOrdLinkID":"symbol","account":"long","symbol":"symbol","side":"symbol","simpleOrderQty":"float","orderQty":"long","price":"float","displayQty":"long","stopPx":"float","pegOffsetValue":"float","pegPriceType":"symbol","currency":"symbol","settlCurrency":"symbol","ordType":"symbol","timeInForce":"symbol","execInst":"symbol","contingencyType":"symbol","exDestination":"symbol","ordStatus":"symbol","triggered":"symbol","workingIndicator":"boolean","ordRejReason":"symbol","simpleLeavesQty":"float","leavesQty":"long","simpleCumQty":"float","cumQty":"long","avgPx":"float","multiLegReportingType":"symbol","text":"string","transactTime":"timestamp","timestamp":"timestamp"},"foreignKeys":{"symbol":"instrument","side":"side","ordStatus":"ordStatus"},"attributes":{"orderID":"grouped","account":"grouped","ordStatus":"grouped","workingIndicator":"grouped"},"filter":{"account":299045,"symbol":"XBTUSD"},"data":[]}
      | {"table":"orderBook10","action":"update","data":[{"symbol":"XBTUSD","asks":[[9770.5,101196],[9771,2095],[9772.5,50],[9773,756],[9773.5,169],[9774,996],[9774.5,167],[9775,3680],[9775.5,353],[9776,198]],"timestamp":"2020-05-07T19:00:53.458Z","bids":[[9770,35719],[9769,31],[9768,50],[9767.5,40],[9765,30],[9764,30],[9763,282],[9762,100],[9760,100],[9759,30]]}]}
      | {"table":"orderBook10","action":"update","data":[{"symbol":"XBTUSD","asks":[[9770.5,101196],[9771,2095],[9772.5,50],[9773,756],[9773.5,244],[9774,996],[9774.5,167],[9775,3680],[9775.5,353],[9776,198]],"timestamp":"2020-05-07T19:00:53.671Z","bids":[[9770,35719],[9769,31],[9768,50],[9767.5,40],[9765,30],[9764,30],[9763,282],[9762,100],[9760,100],[9759,30]]}]}
      |{"status":401,"error":"Signature not valid.","meta":{},"request":{"op":"authKey","args":["KTl_zNoXSONbWlFgRU_6PoiY",1588893594859,"1628B48174CAA478B05047066D059DD06647D159C900442E3AFD8CA89080F621"]}}
      |{"table":"order","action":"insert","data":[{"orderID":"a6e58256-ef3d-08c2-c3f3-1446f28fa86b","clOrdID":"","clOrdLinkID":"","account":299045,"symbol":"XBTUSD","side":"Buy","simpleOrderQty":null,"orderQty":20,"price":9675,"displayQty":null,"stopPx":null,"pegOffsetValue":null,"pegPriceType":"","currency":"USD","settlCurrency":"XBt","ordType":"Limit","timeInForce":"GoodTillCancel","execInst":"ParticipateDoNotInitiate","contingencyType":"","exDestination":"XBME","ordStatus":"Canceled","triggered":"","workingIndicator":false,"ordRejReason":"","simpleLeavesQty":null,"leavesQty":0,"simpleCumQty":null,"cumQty":0,"avgPx":null,"multiLegReportingType":"SingleSecurity","text":"Canceled: Order had execInst of ParticipateDoNotInitiate\nSubmitted via API.","transactTime":"2020-05-09T13:33:06.552Z","timestamp":"2020-05-09T13:33:06.552Z"}]}
      |{"table":"trade","action":"insert","data":[{"timestamp":"2020-05-09T14:31:39.239Z","symbol":"XBTUSD","side":"Sell","size":12,"price":9672.5,"tickDirection":"ZeroMinusTick","trdMatchID":"ae5e6be1-5e64-ac0c-612b-b571e12f637a","grossValue":124068,"homeNotional":0.00124068,"foreignNotional":12}]}
      |{"table":"order","action":"insert","data":[{"orderID":"71498e20-c8f2-b19d-aba2-f64f1edada84","clOrdID":"","clOrdLinkID":"","account":299045,"symbol":"XBTUSD","side":"Buy","simpleOrderQty":null,"orderQty":30,"price":null,"displayQty":null,"stopPx":null,"pegOffsetValue":null,"pegPriceType":"","currency":"USD","settlCurrency":"XBt","ordType":"Market","timeInForce":"ImmediateOrCancel","execInst":"","contingencyType":"","exDestination":"XBME","ordStatus":"New","triggered":"","workingIndicator":false,"ordRejReason":"","simpleLeavesQty":null,"leavesQty":30,"simpleCumQty":null,"cumQty":0,"avgPx":null,"multiLegReportingType":"SingleSecurity","text":"Submission from testnet.bitmex.com","transactTime":"2020-05-19T12:57:38.979Z","timestamp":"2020-05-19T12:57:38.979Z"}]}
      |{"table":"order","action":"update","data":[{"orderID":"9650dd7b-c54e-c833-b291-e7024249f53d","price":9600,"ordStatus":"Filled","leavesQty":0,"cumQty":30,"avgPx":9599.5,"clOrdID":"","account":299045,"symbol":"XBTUSD","timestamp":"2020-05-19T12:58:12.974Z"}]}
      |{"table":"order","action":"update","data":[{"orderID":"1978e77e-3380-8858-ec22-5e17f6947fa7","workingIndicator":true,"clOrdID":"","account":299045,"symbol":"XBTUSD","timestamp":"2020-05-19T12:59:12.092Z"}]}
      |{"table":"order","action":"update","data":[{"orderID":"1978e77e-3380-8858-ec22-5e17f6947fa7","ordStatus":"Canceled","workingIndicator":false,"leavesQty":0,"text":"Canceled: Cancel from testnet.bitmex.com\nSubmission from testnet.bitmex.com","timestamp":"2020-05-19T13:00:19.115Z","clOrdID":"","account":299045,"symbol":"XBTUSD"}]}
      |{"table":"order","action":"insert","data":[{"orderID":"092ea086-c91d-7f43-7551-086bbe7a5b8c","clOrdID":"","clOrdLinkID":"","account":299045,"symbol":"XBTUSD","side":"Buy","simpleOrderQty":null,"orderQty":30,"price":9608.5,"displayQty":null,"stopPx":null,"pegOffsetValue":null,"pegPriceType":"","currency":"USD","settlCurrency":"XBt","ordType":"Limit","timeInForce":"GoodTillCancel","execInst":"ParticipateDoNotInitiate","contingencyType":"","exDestination":"XBME","ordStatus":"Canceled","triggered":"","workingIndicator":false,"ordRejReason":"","simpleLeavesQty":null,"leavesQty":0,"simpleCumQty":null,"cumQty":0,"avgPx":null,"multiLegReportingType":"SingleSecurity","text":"Canceled: Order had execInst of ParticipateDoNotInitiate\nSubmission from testnet.bitmex.com","transactTime":"2020-05-19T13:01:06.689Z","timestamp":"2020-05-19T13:01:06.689Z"}]}
      |{"table":"order","action":"update","data":[{"orderID":"65c59260-5487-abec-7778-9c785b547dbd","workingIndicator":true,"clOrdID":"","account":299045,"symbol":"XBTUSD","timestamp":"2020-05-19T13:01:59.744Z"}]}
      |{"table":"order","action":"update","data":[{"orderID":"65c59260-5487-abec-7778-9c785b547dbd","ordStatus":"Canceled","workingIndicator":false,"leavesQty":0,"text":"Canceled: Cancel from testnet.bitmex.com\nSubmission from testnet.bitmex.com","timestamp":"2020-05-19T13:04:34.924Z","clOrdID":"","account":299045,"symbol":"XBTUSD"}]}
      |{"table":"order","action":"insert","data":[{"orderID":"a7a98b27-1cb0-1978-58df-8f68de0b6696","clOrdID":"","clOrdLinkID":"","account":299045,"symbol":"XBTUSD","side":"Sell","simpleOrderQty":null,"orderQty":30,"price":null,"displayQty":null,"stopPx":9600,"pegOffsetValue":null,"pegPriceType":"","currency":"USD","settlCurrency":"XBt","ordType":"Stop","timeInForce":"ImmediateOrCancel","execInst":"","contingencyType":"","exDestination":"XBME","ordStatus":"New","triggered":"","workingIndicator":false,"ordRejReason":"","simpleLeavesQty":null,"leavesQty":30,"simpleCumQty":null,"cumQty":0,"avgPx":null,"multiLegReportingType":"SingleSecurity","text":"Submission from testnet.bitmex.com","transactTime":"2020-05-19T13:05:44.155Z","timestamp":"2020-05-19T13:05:44.155Z"}]}
      |{"table":"order","action":"insert","data":[{"orderID":"2f01f1a3-b538-dd23-e336-206283485b53","clOrdID":"","clOrdLinkID":"","account":299045,"symbol":"XBTUSD","side":"Sell","simpleOrderQty":null,"orderQty":30,"price":null,"displayQty":null,"stopPx":9600,"pegOffsetValue":null,"pegPriceType":"","currency":"USD","settlCurrency":"XBt","ordType":"Stop","timeInForce":"ImmediateOrCancel","execInst":"LastPrice","contingencyType":"","exDestination":"XBME","ordStatus":"New","triggered":"","workingIndicator":false,"ordRejReason":"","simpleLeavesQty":null,"leavesQty":30,"simpleCumQty":null,"cumQty":0,"avgPx":null,"multiLegReportingType":"SingleSecurity","text":"Submission from testnet.bitmex.com","transactTime":"2020-05-19T13:09:48.127Z","timestamp":"2020-05-19T13:09:48.127Z"}]}
      |{"table":"order","action":"update","data":[{"orderID":"2f01f1a3-b538-dd23-e336-206283485b53","triggered":"StopOrderTriggered","text":"Triggered: Order stop price reached\nSubmission from testnet.bitmex.com","timestamp":"2020-05-19T13:10:19.034Z","clOrdID":"","account":299045,"symbol":"XBTUSD"}]}
      |{"table":"order","action":"update","data":[{"orderID":"2f01f1a3-b538-dd23-e336-206283485b53","price":9600,"ordStatus":"Filled","leavesQty":0,"cumQty":30,"avgPx":9599.5,"transactTime":"2020-05-19T13:10:19.034Z","clOrdID":"","account":299045,"symbol":"XBTUSD","timestamp":"2020-05-19T13:10:19.034Z"}]}
      |{"table":"instrument","action":"update","data":[{"symbol":".BXBT","lastPrice":8857.35,"lastChangePcnt":-0.006,"markPrice":8857.35,"timestamp":"2020-05-27T05:05:25.000Z"}]}
      |{"table":"trade","action":"insert","data":[{"timestamp":"2020-05-27T10:02:23.662Z","symbol":"XBTUSD","side":"Sell","size":1,"price":8977,"tickDirection":"MinusTick","trdMatchID":"73aca494-756e-e7bb-edb1-985566865705","grossValue":11140,"homeNotional":0.0001114,"foreignNotional":1},{"timestamp":"2020-05-27T10:02:23.662Z","symbol":"XBTUSD","side":"Sell","size":75,"price":8977,"tickDirection":"ZeroMinusTick","trdMatchID":"be14f850-4a94-bbb8-d298-5f225a562cf1","grossValue":835500,"homeNotional":0.008355,"foreignNotional":75},{"timestamp":"2020-05-27T10:02:23.662Z","symbol":"XBTUSD","side":"Sell","size":100,"price":8977,"tickDirection":"ZeroMinusTick","trdMatchID":"19c26fbe-8795-9213-7fd9-4f92c1da717d","grossValue":1114000,"homeNotional":0.01114,"foreignNotional":100},{"timestamp":"2020-05-27T10:02:23.662Z","symbol":"XBTUSD","side":"Sell","size":503,"price":8977,"tickDirection":"ZeroMinusTick","trdMatchID":"0c5ee155-d5e7-0c10-64ca-5e85ecd69b9c","grossValue":5603420,"homeNotional":0.0560342,"foreignNotional":503},{"timestamp":"2020-05-27T10:02:23.662Z","symbol":"XBTUSD","side":"Sell","size":535,"price":8977,"tickDirection":"ZeroMinusTick","trdMatchID":"56e9ceb6-e7a9-d532-4682-7c108a08899f","grossValue":5959900,"homeNotional":0.059599,"foreignNotional":535},{"timestamp":"2020-05-27T10:02:23.662Z","symbol":"XBTUSD","side":"Sell","size":75,"price":8975.5,"tickDirection":"MinusTick","trdMatchID":"e88a7d88-d8da-43a5-a699-79c5fba3da6b","grossValue":835575,"homeNotional":0.00835575,"foreignNotional":75},{"timestamp":"2020-05-27T10:02:23.662Z","symbol":"XBTUSD","side":"Sell","size":100,"price":8975.5,"tickDirection":"ZeroMinusTick","trdMatchID":"a30acf4b-fa11-bec4-0cfd-b1bcaf609463","grossValue":1114100,"homeNotional":0.011141,"foreignNotional":100}]}
      |{"table":"funding","action":"insert","data":[{"timestamp":"2020-05-28T12:00:00.000Z","symbol":"XBTUSD","fundingInterval":"2000-01-01T08:00:00.000Z","fundingRate":0.0001,"fundingRateDaily":0.00030000000000000003}]}
      |""".stripMargin

  val wsMessages__broken =
    """
      |{"table":"order","action":"insert","data":[{"orderID":"296533b0-61e2-842a-1860-8913add52d2b","clOrdID":"","clOrdLinkID":"","account":1502286,"symbol":"XBTUSD","side":"","simpleOrderQty":null,"orderQty":null,"price":null,"displayQty":null,"stopPx":null,"pegOffsetValue":null,"pegPriceType":"","currency":"USD","settlCurrency":"XBt","ordType":"Market","timeInForce":"ImmediateOrCancel","execInst":"Close","contingencyType":"","exDestination":"XBME","ordStatus":"New","triggered":"","workingIndicator":false,"ordRejReason":"","simpleLeavesQty":null,"leavesQty":null,"simpleCumQty":null,"cumQty":0,"avgPx":null,"multiLegReportingType":"SingleSecurity","text":"Position Close from www.bitmex.com","transactTime":"2020-05-28T19:30:05.063Z","timestamp":"2020-05-28T19:30:05.063Z"}]}
      |""".stripMargin

  "WsModel" should "unmarshall known WS json messages" in {
    val res = wsMessages.split("\n").filter(s => ! s.isEmpty).map(WsModel.asModel)
    print(res.mkString("\n"))
    res.filter(j => j.isError) shouldBe empty
  }

  // FIXME: ignore for now!
  it should "unmarshall these broken json messages too" in pendingUntilFixed {
    val res = wsMessages__broken.split("\n").filter(s => ! s.isEmpty).map(WsModel.asModel)
    print(res.mkString("\n"))
    res.filter(j => j.isError) shouldBe empty
  }
}
